<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>êµë¬´ ìˆ˜ì²© (Class Assistant)</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #F9F9F7;
            --sidebar-bg: #2C3E50;
            --sidebar-text: #ECF0F1;
            --primary: #34495E;
            --accent: #D35400;
            --highlight: #F1C40F;
            --card-bg: #FFFFFF;
            --border: #E0E0E0;
            --text-main: #2C3E50;
            --text-sub: #7F8C8D;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
        }

        .app-layout { display: flex; height: 100vh; width: 100vw; }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 240px; background: var(--sidebar-bg); color: var(--sidebar-text);
            display: flex; flex-direction: column; padding: 20px; flex-shrink: 0;
            overflow-y: auto; z-index: 200;
        }
        .sidebar-brand { font-size: 1.2rem; font-weight: 700; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .sidebar-menu { display: flex; flex-direction: column; gap: 10px; }
        .menu-btn {
            background: transparent; border: none; color: #BDC3C7;
            padding: 12px 15px; text-align: left; font-size: 1rem;
            cursor: pointer; border-radius: 8px; transition: 0.2s;
            display: flex; align-items: center; gap: 12px;
        }
        .menu-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .menu-btn.active { background: var(--accent); color: white; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .user-profile { margin-top: auto; font-size: 0.9rem; color: #BDC3C7; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        .page-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; display: none; }

        /* ë ˆì´ì•„ì›ƒ ì „ëµ */
        .split-view {
            display: grid; grid-template-columns: 1fr; gap: 20px;
            max-width: 1200px; margin: 0 auto;
        }
        @media (min-width: 1201px) {
            .page-title { display: block; }
            .split-view { grid-template-columns: 1fr 1fr; align-items: start; }
            .result-container { position: sticky; top: 20px; }
        }

        .ai-grid-layout { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 1201px) {
            .ai-grid-layout {
                grid-template-columns: 1fr 1fr;
                grid-template-areas: "question result" "batch result";
                align-items: start;
            }
            .area-question { grid-area: question; }
            .area-batch { grid-area: batch; }
            .area-result { grid-area: result; position: sticky; top: 20px; }
        }

        /* ëª¨ë°”ì¼ ì œì–´ */
        @media (max-width: 768px) {
            .sidebar { display: none; } 
            .mobile-nav { display: flex !important; } 
            .main-content { padding-bottom: 100px; } 
        }
        @media (min-width: 769px) {
            .page-title { display: block; }
            .sidebar { display: flex; } 
            .mobile-nav { display: none !important; } 
        }

        /* UI ì»´í¬ë„ŒíŠ¸ */
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); margin-bottom: 15px; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; box-sizing: border-box; background: #FAFAFA; font-family: inherit;}
        input:focus, textarea:focus, select:focus { border-color: var(--accent); outline: none; background: white; box-shadow: 0 0 0 3px rgba(211, 84, 0, 0.1); }
        
        textarea.auto-resize {
            resize: none; overflow-y: hidden; min-height: 120px; line-height: 1.6; transition: height 0.1s;
        }
        textarea.auto-resize { max-height: 150px; }
        @media (min-width: 768px) { textarea.auto-resize { max-height: 300px; } }
        @media (min-width: 1201px) { textarea.auto-resize { max-height: 500px; } }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;}
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn:active { transform: scale(0.98); opacity: 0.9; }

        .call-btn { text-decoration: none; background: #e6f4ea; color: #137333; padding: 6px 12px; border-radius: 6px; font-size: 0.8em; font-weight: bold; }

        .toolbar { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .tool-chip { background: white; border: 1px solid var(--border); padding: 6px 12px; border-radius: 20px; font-size: 0.9rem; color: var(--text-sub); cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .mic-active { color: #E74C3C !important; border-color: #E74C3C !important; background-color: #FDEDEC !important; animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
        #mic-status { display: none; color: #E74C3C; font-weight: bold; font-size: 0.85rem; margin-left: auto; align-items: center; gap: 5px; }

        .result-paper { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 4px; border-left: 4px solid var(--accent); line-height: 1.7; min-height: 100px; white-space: pre-wrap; background-image: linear-gradient(#eee .1rem, transparent .1rem); background-size: 100% 2rem; background-position: 0 1.5rem; }
        .mask-highlight { background: linear-gradient(to top, var(--highlight) 50%, transparent 50%); font-weight: bold; padding: 0 2px; }

        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .login-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; max-width: 320px; width: 90%; border: 1px solid var(--border); }
        
        .mobile-nav { 
            display: none; position: fixed; bottom: 0; left: 0; width: 100%; 
            background: white; border-top: 1px solid var(--border); 
            justify-content: space-around; padding: 12px 0; z-index: 9999; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-item { background: none; border: none; color: var(--text-sub); display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; gap: 5px; cursor: pointer; }
        .nav-item.active { color: var(--accent); font-weight: bold; }
        .nav-item i { font-size: 1.4rem; }

        #toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 30px; font-size: 0.9rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 10000; }
        #toast-container.show { opacity: 1; bottom: 90px; }
        .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; align-items: center; justify-content: center; z-index: 10; border-radius: 12px; font-weight: bold; color: var(--primary); }

        .api-status-box { padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold; }
        .status-ok { background: #E8F8F5; color: #27AE60; border: 1px solid #27AE60; }
        .status-no { background: #FDEDEC; color: #C0392B; border: 1px solid #C0392B; }
    </style>
</head>
<body>

    <datalist id="student-list-data"></datalist>

    <div id="login-screen">
        <div class="login-card">
            <i class="fas fa-book-open" style="font-size: 3rem; color: var(--accent); margin-bottom: 20px;"></i>
            <h2 style="margin: 0 0 10px 0; color: var(--primary);">êµë¬´ ìˆ˜ì²©</h2>
            <p style="color: var(--text-sub); margin-bottom: 30px;">ì„ ìƒë‹˜ì„ ìœ„í•œ ìŠ¤ë§ˆíŠ¸í•œ ê¸°ë¡ ë¹„ì„œ</p>
            
            <div id="g_btn_wrapper">
                <div id="g_id_onload" data-client_id="1075901830630-jss5b3872vlu0p34t5i8j97gu3puonju.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>
                <div class="g_id_signin" data-type="standard" data-size="large" data-width="280"></div>
            </div>
            <div id="login-loading" style="display:none; font-weight:bold; color:var(--text-sub);">
                <i class="fas fa-circle-notch fa-spin"></i> ì„ ìƒë‹˜ í™•ì¸ ì¤‘...
            </div>
        </div>
    </div>

    <div id="app-screen" class="app-layout" style="display:none;">
        
        <nav class="sidebar">
            <div class="sidebar-brand">
                <i class="fas fa-book-open" style="color: var(--accent);"></i> êµë¬´ ìˆ˜ì²©
            </div>
            <div class="sidebar-menu">
                <button class="menu-btn active" onclick="goTab('search')"><i class="fas fa-search"></i> í•™ìƒ ì¡°íšŒ</button>
                <button class="menu-btn" onclick="goTab('log')"><i class="fas fa-pen-fancy"></i> ê¸°ë¡ í•˜ê¸°</button>
                <button class="menu-btn" onclick="goTab('ai')"><i class="fas fa-robot"></i> AI ì—…ë¬´</button>
                <button class="menu-btn" onclick="goTab('settings')"><i class="fas fa-cog"></i> ì„¤ì •</button>
            </div>
            <div class="user-profile">
                <i class="fas fa-user-circle"></i> <span id="user-badge">ì„ ìƒë‹˜</span>
            </div>
        </nav>

        <main class="main-content">
            
            <div id="tab-search" class="section active">
                <h2 class="page-title">í•™ìƒ ì¡°íšŒ</h2>
                <div class="split-view">
                    <div class="input-container">
                        <div class="card">
                            <label style="font-weight:bold; display:block; margin-bottom:10px;">ëˆ„êµ¬ë¥¼ ì°¾ìœ¼ì‹œë‚˜ìš”?</label>
                            <div style="display:flex; gap:10px;">
                                <input type="text" id="s-input" placeholder="ì´ë¦„ (ì˜ˆ: í”¼ì¹´ì¸„)" onkeydown="if(event.key==='Enter') search()" list="student-list-data">
                                <button class="btn btn-primary" style="width:60px;" onclick="search()"><i class="fas fa-search"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="result-container">
                        <div id="s-result">
                            <div style="text-align:center; color:var(--text-sub); padding:40px;">
                                <i class="fas fa-id-card" style="font-size:3rem; opacity:0.3; margin-bottom:10px;"></i>
                                <p>í•™ìƒ ì´ë¦„ì„ ê²€ìƒ‰í•˜ë©´<br>ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-log" class="section" style="display:none;">
                <h2 class="page-title">ê´€ì°° ê¸°ë¡</h2>
                <div class="split-view">
                    <div class="input-container">
                        <div class="card">
                            <input type="text" id="l-name" placeholder="ì´ë¦„ (ì—¬ëŸ¬ ëª…ì€ ì‰¼í‘œ , ë¡œ êµ¬ë¶„)" list="student-list-data">
                            <select id="l-cate">
                                <option value="ìˆ˜ì—…">ìˆ˜ì—… íƒœë„/ì°¸ì—¬</option>
                                <option value="ìƒí™œ">ìƒí™œ/í–‰ë™ íŠ¹ì„±</option>
                                <option value="ìƒë‹´">ìƒë‹´ ë‚´ìš©</option>
                                <option value="ê¸°íƒ€">ê¸°íƒ€ ë©”ëª¨</option>
                            </select>
                            
                            <div class="toolbar">
                                <div class="tool-chip" id="btn-mic" onclick="toggleMic()">
                                    <i class="fas fa-microphone"></i> ìŒì„±
                                </div>
                                <label class="tool-chip"><i class="fas fa-file-upload"></i> íŒŒì¼(TXT) <input type="file" accept=".txt" style="display:none" onchange="loadFile(this)"></label>
                                <div id="mic-status"><i class="fas fa-circle fa-beat" style="font-size:0.6rem;"></i> ë“£ê³  ìˆì–´ìš”...</div>
                            </div>
                            
                            <div style="position:relative;">
                                <textarea id="l-content" class="auto-resize" oninput="handleResize(this)" placeholder="ì˜¤ëŠ˜ ìˆì—ˆë˜ ì¼ì„ ê¸°ë¡í•˜ì„¸ìš”.&#13;&#10;**ì¤‘ìš”í•œ ì´ë¦„**ì€ ë³„í‘œë¡œ ê°ì‹¸ë©´ ìµëª…í™”ë©ë‹ˆë‹¤."></textarea>
                                <div id="log-loading" class="loading-overlay"><i class="fas fa-spinner fa-spin"></i></div>
                            </div>

                            <button class="btn btn-accent" onclick="saveLog()"><i class="fas fa-save"></i> ê¸°ë¡ ì €ì¥</button>
                        </div>
                    </div>
                    <div class="result-container">
                        <div class="card">
                            <h4 style="margin-top:0; color:var(--text-sub);">ğŸ’¡ ê¸°ë¡ ê°€ì´ë“œ</h4>
                            <ul style="font-size:0.9rem; color:var(--text-sub); padding-left:20px; line-height:1.6;">
                                <li><strong>ì—¬ëŸ¬ ëª…</strong>ì€ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•´ì„œ ì…ë ¥í•˜ì„¸ìš”.<br>(ì˜ˆ: ê¹€ì² ìˆ˜, ì´ì˜í¬)</li>
                                <li><strong>**ì´ë¦„**</strong> ì²˜ëŸ¼ ë³„í‘œë¡œ ê°ì‹¸ë©´ AIì—ê²Œ ë¹„ë°€ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.</li>
                                <li>íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ë‚´ìš©ì„ ì±„ì›Œì¤ë‹ˆë‹¤.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-ai" class="section" style="display:none;">
                <h2 class="page-title">AI ì—…ë¬´ ë³´ì¡°</h2>
                
                <div class="ai-grid-layout">
                    <div class="card area-question">
                        <h3 style="font-size:1.1rem; margin-top:0;"><i class="fas fa-comment-dots"></i> AI ì–´ì‹œìŠ¤í„´íŠ¸</h3>
                        <input type="text" id="a-name" placeholder="ëŒ€ìƒ í•™ìƒ ì´ë¦„ (ë¹„ì›Œë‘ë©´ ì „ì²´ ë¶„ì„)" list="student-list-data">
                        <textarea id="a-query" class="auto-resize" oninput="handleResize(this)" placeholder="ì˜ˆ: ì´ í•™ìƒì˜ í–‰ë™ íŠ¹ì„±ì„ ìš”ì•½í•´ì¤˜, ë˜ëŠ” ìš°ë¦¬ ë°˜ ì „ì²´ ë¶„ìœ„ê¸°ëŠ” ì–´ë•Œ?"></textarea>
                        <button class="btn btn-primary" onclick="askAI()"><i class="fas fa-paper-plane"></i> ì§ˆë¬¸í•˜ê¸°</button>
                    </div>

                    <div class="result-container area-result">
                        <div id="a-loading" style="display:none; text-align:center; padding:50px;">
                            <i class="fas fa-robot fa-bounce" style="font-size:2rem; color:var(--primary);"></i>
                            <p style="margin-top:20px;">AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
                        </div>
                        
                        <div id="a-result-box" style="display:none;">
                            <label style="font-weight:bold; color:var(--accent); display:block; margin-bottom:5px;">AI ë‹µë³€:</label>
                            <div id="a-result" class="result-paper"></div>
                        </div>

                        <div id="a-placeholder" style="text-align:center; color:var(--text-sub); padding:40px 20px; background:#fff; border-radius:12px; border:1px dashed #ddd;">
                            <i class="fas fa-sparkles" style="font-size:2rem; opacity:0.3; margin-bottom:15px;"></i>
                            <p style="font-size:0.9rem;">ì§ˆë¬¸í•˜ë©´ ë‹µë³€ì´<br>ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="card area-batch" style="border:1px dashed var(--primary); background:#F4F6F7;">
                        <h3 style="font-size:1.1rem; margin-top:0; color:var(--primary);"><i class="fas fa-magic"></i> ìƒê¸°ë¶€ ì¼ê´„ ìƒì„±</h3>
                        <p style="font-size:0.85rem; color:var(--text-sub); margin-bottom:15px;">
                            ì „ì²´ í•™ìƒ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì´ˆì•ˆì„ ì‘ì„±í•©ë‹ˆë‹¤.
                        </p>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-accent" style="flex:1; background:#27AE60;" onclick="batch('í–‰ë™íŠ¹ì„±')">í–‰íŠ¹</button>
                            <button class="btn btn-accent" style="flex:1; background:#F39C12;" onclick="batchSub()">êµê³¼</button>
                        </div>
                        <div id="batch-box" style="display:none; margin-top:15px; background:#fff; padding:10px; border-radius:8px; border:1px solid #ddd;">
                            <div id="batch-txt" style="font-size:0.8rem; font-weight:bold; margin-bottom:5px;">ì¤€ë¹„ ì¤‘...</div>
                            <div style="background:#ddd; height:6px; border-radius:3px; overflow:hidden;">
                                <div id="batch-bar" style="width:0%; height:100%; background:var(--accent); transition:width 0.3s;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-settings" class="section" style="display:none;">
                <h2 class="page-title">í™˜ê²½ ì„¤ì •</h2>
                <div class="split-view">
                    <div>
                        <div class="card">
                            <h3 style="margin-top:0;"><i class="fas fa-key"></i> AI í‚¤ ì„¤ì • (í•„ìˆ˜)</h3>
                            <p style="font-size:0.9rem; color:var(--text-sub);">
                                AI ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ <strong>ê°œì¸ Gemini API í‚¤</strong>ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br>
                                í‚¤ëŠ” ì„ ìƒë‹˜ì˜ êµ¬ê¸€ ê³„ì •ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ë©° ê´€ë¦¬ìì—ê²Œ ê³µê°œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                            </p>
                            
                            <div id="api-status" class="api-status-box status-no">
                                <i class="fas fa-exclamation-triangle"></i> í™•ì¸ ì¤‘...
                            </div>

                            <label style="font-weight:bold; display:block; margin-bottom:10px;">API í‚¤ ì…ë ¥</label>
                            <input type="password" id="api-key-input" placeholder="AI Studioì—ì„œ ë°œê¸‰ë°›ì€ í‚¤ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”">
                            <button class="btn btn-primary" onclick="saveApiKey()">
                                <i class="fas fa-save"></i> í‚¤ ì €ì¥í•˜ê¸°
                            </button>
                            <div style="margin-top:15px; text-align:center;">
                                <a href="https://aistudio.google.com/app/apikey" target="_blank" style="font-size:0.9rem; color:var(--accent); text-decoration:none;">
                                    ğŸ‘‰ ë¬´ë£Œ API í‚¤ ë°œê¸‰ë°›ê¸° (Google AI Studio)
                                </a>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="card">
                            <h3 style="margin-top:0;"><i class="fas fa-database"></i> ë°ì´í„° ê´€ë¦¬</h3>
                            <p style="font-size:0.9rem; color:var(--text-sub);">
                                ëª¨ë“  ê¸°ë¡ì€ ì„ ìƒë‹˜ì˜ êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ìˆëŠ”<br>
                                <strong>[êµë¬´ìˆ˜ì²©_ë°ì´í„°]</strong> ì—‘ì…€ íŒŒì¼ì— ì €ì¥ë©ë‹ˆë‹¤.
                            </p>
                            <button class="btn btn-accent" onclick="openMySheet()">
                                <i class="fas fa-external-link-alt"></i> ë‚´ ë°ì´í„° ì‹œíŠ¸ ì—´ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
        
        <nav class="mobile-nav">
            <button class="nav-item active" onclick="goTab('search')">
                <i class="fas fa-search"></i> ì¡°íšŒ
            </button>
            <button class="nav-item" onclick="goTab('log')">
                <i class="fas fa-pen"></i> ê¸°ë¡
            </button>
            <button class="nav-item" onclick="goTab('ai')">
                <i class="fas fa-robot"></i> AI
            </button>
            <button class="nav-item" onclick="goTab('settings')">
                <i class="fas fa-cog"></i> ì„¤ì •
            </button>
        </nav>

    </div>

    <div id="toast-container">ë©”ì‹œì§€ ë‚´ìš©</div>

    <script>
        // â˜… ì„ ìƒë‹˜ì˜ GAS ì›¹ ì•± URL (ë°˜ë“œì‹œ /execë¡œ ëë‚˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”) â˜…
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxSN13JeSbxS7JM-LKn7pG8yHtJDbjnuggeanYs8566_kr6-TxFiaB2ghk6ARdkfWs/exec"; 
        let TOKEN = "";

        // [í•µì‹¬] ë¡œê·¸ì¸ ì²˜ë¦¬ ë° í†µì‹  ë¡œì§ (ë¬¸ë²• ì˜¤ë¥˜ ìˆ˜ì •ë¨)
        window.handleCredentialResponse = async function(res) {
            console.log("ğŸš€ [1] êµ¬ê¸€ ë¡œê·¸ì¸ ì„±ê³µ! í† í° ìˆ˜ì‹  ì™„ë£Œ.");
            TOKEN = res.credential;
            
            document.getElementById("g_btn_wrapper").style.display = "none";
            document.getElementById("login-loading").style.display = "block";

            try {
                console.log("ğŸš€ [2] GAS ì„œë²„ë¡œ ë¡œê·¸ì¸ ìš”ì²­ ì „ì†¡ ì¤‘...");
                const userData = await api("login", {}, true);

                if (userData) {
                    console.log("âœ… [4] ë¡œê·¸ì¸ ì„±ê³µ! ì‚¬ìš©ì ë°ì´í„° ìˆ˜ì‹ :", userData);
                    document.getElementById("login-screen").style.display = "none";
                    document.getElementById("app-screen").style.display = "flex";
                    document.getElementById("user-badge").innerText = userData.name + " ì„ ìƒë‹˜";
                    
                    showToast(`í™˜ì˜í•©ë‹ˆë‹¤, ${userData.name} ì„ ìƒë‹˜!`);
                    loadStudentListForAutocomplete();
                    checkApiKeyStatus();
                } else {
                    throw new Error("ì„œë²„ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°›ì•„ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }
            } catch (e) {
                console.error("âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨:", e);
                alert("ë¡œê·¸ì¸ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n" + e.message);
                location.reload(); 
            }
        };

        // [í•µì‹¬] API í†µì‹  í•¨ìˆ˜ (CORS íšŒí”¼ìš© text/plain ì„¤ì • ì ìš©)
        async function api(act, pl, isLogin = false) {
            try {
                // headersë¥¼ ì œê±°í•˜ì—¬ Simple Requestë¡œ ì „ì†¡
                const res = await fetch(GAS_URL, { 
                    method: "POST", 
                    body: JSON.stringify({ token: TOKEN, action: act, ...pl })
                });

                // GASì˜ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‘ë‹µì„ í…ìŠ¤íŠ¸ë¡œ ë°›ì•„ì„œ JSON íŒŒì‹±
                const text = await res.text();
                
                // HTML ì—ëŸ¬ í˜ì´ì§€ê°€ ë°˜í™˜ë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (text.trim().startsWith("<")) {
                    console.error("âŒ ì„œë²„ê°€ HTMLì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ ì—ëŸ¬ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", text);
                    throw new Error("ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ (GAS ìŠ¤í¬ë¦½íŠ¸ í™•ì¸ í•„ìš”)");
                }

                const json = JSON.parse(text);

                if(json.status === "error") {
                    if(isLogin) throw new Error(json.message);
                    alert("ì˜¤ë¥˜: " + json.message); 
                    return null;
                }
                return json.data;
            } catch(e) { 
                if(isLogin) throw e; 
                console.error("í†µì‹  ì˜¤ë¥˜ ìƒì„¸:", e);
                alert("í†µì‹  ì˜¤ë¥˜: " + e.message); 
                return null; 
            }
        }

        // --- ê¸°íƒ€ UI í•¨ìˆ˜ë“¤ ---

        function handleResize(el) {
            el.style.height = 'auto'; 
            el.style.height = (el.scrollHeight) + 'px'; 
            if (el.clientHeight < el.scrollHeight) el.style.overflowY = 'auto';
            else el.style.overflowY = 'hidden';
        }

        function goTab(id) {
            document.querySelectorAll('.section').forEach(e => e.style.display = 'none');
            document.getElementById('tab-'+id).style.display = 'block';
            
            document.querySelectorAll('.menu-btn, .nav-item').forEach(e => e.classList.remove('active'));
            const index = ['search', 'log', 'ai', 'settings'].indexOf(id);
            if(index >= 0) {
                document.querySelectorAll('.sidebar-menu .menu-btn')[index].classList.add('active');
                document.querySelectorAll('.mobile-nav .nav-item')[index].classList.add('active');
            }
        }

        function showToast(msg) {
            const el = document.getElementById("toast-container");
            el.innerText = msg;
            el.classList.add("show");
            setTimeout(() => el.classList.remove("show"), 3000);
        }

        function renderMarkdown(text) {
            if (!text) return "";
            return text.replace(/\*\*(.*?)\*\*/g, '<span class="mask-highlight">$1</span>');
        }

        async function loadStudentListForAutocomplete() {
            const names = await api("getAllStudentNames", {});
            if (!names) return;
            const datalist = document.getElementById("student-list-data");
            datalist.innerHTML = names.map(n => `<option value="${n}">`).join('');
        }

        async function checkApiKeyStatus() {
            const box = document.getElementById("api-status");
            const res = await api("checkApiKey", {});
            if(res && res.hasKey) {
                box.className = "api-status-box status-ok";
                box.innerHTML = `<i class="fas fa-check-circle"></i> API í‚¤ê°€ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br><span style="font-weight:normal; font-size:0.8rem;">(${res.maskedKey})</span>`;
            } else {
                box.className = "api-status-box status-no";
                box.innerHTML = `<i class="fas fa-exclamation-circle"></i> API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`;
            }
        }

        async function saveApiKey() {
            const key = document.getElementById("api-key-input").value.trim();
            if(!key) return alert("API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            
            if(confirm("ì´ í‚¤ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ê¸°ì¡´ í‚¤ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤)")) {
                const res = await api("setApiKey", { apiKey: key });
                if(res) {
                    showToast(res.message);
                    document.getElementById("api-key-input").value = "";
                    checkApiKeyStatus();
                }
            }
        }

        async function openMySheet() {
            const res = await api("getDataSheetUrl", {});
            if(res && res.url) window.open(res.url, "_blank");
        }

        async function search() {
            const name = document.getElementById("s-input").value.trim();
            if(!name) return showToast("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            
            const box = document.getElementById("s-result");
            box.innerHTML = `<div style="text-align:center; padding:40px;"><i class="fas fa-spinner fa-spin fa-2x"></i><br><br>ìƒí™œê¸°ë¡ë¶€ë¥¼ ì°¾ëŠ” ì¤‘...</div>`;
            
            const d = await api("getStudentInfo", { studentName: name });
            if(d) {
                const subParentCallBtn = d.parentSub ? `<a href="tel:${d.parentSub}" class="call-btn" style="text-decoration:none;">í†µí™”</a>` : '';
                box.innerHTML = `
                <div class="card" style="border-top: 4px solid var(--accent);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h2 style="margin:0;">${d.name}</h2>
                        <span style="background:#eee; padding:4px 8px; border-radius:4px; font-size:0.9rem;">${d.birth}</span>
                    </div>
                    <div class="info-list">
                        <div class="info-item">
                            <div class="info-icon"><i class="fas fa-user-check"></i></div>
                            <div class="info-text"><span class="info-label">(ì£¼)ë³´í˜¸ì</span><span class="info-value">${d.parentMain}</span></div>
                            <a href="tel:${d.parentMain}" class="call-btn" style="text-decoration:none;">í†µí™”</a>
                        </div>
                        <div class="info-item">
                            <div class="info-icon"><i class="fas fa-user-friends"></i></div>
                            <div class="info-text"><span class="info-label">(ë¶€)ë³´í˜¸ì</span><span class="info-value">${d.parentSub||"-"}</span></div>
                            ${subParentCallBtn}
                        </div>
                        <div class="info-item">
                            <div class="info-icon"><i class="fas fa-map-marker-alt"></i></div>
                            <div class="info-text"><span class="info-label">ì£¼ì†Œ</span><span class="info-value" style="font-size:0.9rem">${d.address}</span></div>
                        </div>
                    </div>
                    <div style="margin-top:20px; background:#FEF9E7; padding:15px; border-radius:8px;">
                        <strong>âš ï¸ íŠ¹ì´ì‚¬í•­</strong><br>${d.memo||"ì—†ìŒ"}
                    </div>
                </div>`;
            } else {
                box.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-sub);">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
            }
        }

        async function saveLog() {
            const n = document.getElementById("l-name").value;
            const c = document.getElementById("l-content").value;
            if(!n || !c) return showToast("ì´ë¦„ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            
            if(confirm("ê¸°ë¡ì„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                if(await api("addLog", { payload: { studentName: n, category: document.getElementById("l-cate").value, content: c } })) {
                    showToast("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“");
                    document.getElementById("l-content").value = "";
                    handleResize(document.getElementById("l-content"));
                }
            }
        }

        function loadFile(input) {
            const file = input.files[0];
            if (!file) return;
            const name = document.getElementById("l-name").value.trim();
            if (!name) {
                input.value = ""; return alert("ë¨¼ì € í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            }
            const reader = new FileReader();
            reader.onload = async function(e) {
                document.getElementById("log-loading").style.display = "flex";
                const data = await api("previewMasking", { studentName: name, content: e.target.result });
                document.getElementById("log-loading").style.display = "none";
                if (data) {
                    const textArea = document.getElementById("l-content");
                    textArea.value = data.maskedContent;
                    showToast("íŒŒì¼ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
                    handleResize(textArea);
                }
            };
            reader.readAsText(file);
            input.value = "";
        }

        async function askAI() {
            const n = document.getElementById("a-name").value;
            const q = document.getElementById("a-query").value;
            if(!q) return showToast("ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            document.getElementById("a-placeholder").style.display = "none";
            document.getElementById("a-result-box").style.display = "none";
            document.getElementById("a-loading").style.display = "block";
            
            const d = await api("askAI", { studentName: n, query: q });
            document.getElementById("a-loading").style.display = "none";
            if(d) {
                document.getElementById("a-result-box").style.display = "block";
                document.getElementById("a-result").innerHTML = renderMarkdown(d.answer);
            }
        }

        function batchSub() { const s = prompt("ê³¼ëª©ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: êµ­ì–´)"); if(s) batch('êµê³¼ì„¸íŠ¹', s); }
        
        async function batch(type, sub="") {
            if(!confirm(`ì „ì²´ í•™ìƒì˜ [${type}] ì´ˆì•ˆì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            document.getElementById("batch-box").style.display = "block";
            const names = await api("getAllStudentNames", {});
            if(!names) return;
            
            const txt = document.getElementById("batch-txt");
            const bar = document.getElementById("batch-bar");
            let cnt = 0;
            
            for(let i=0; i<names.length; i++) {
                const per = Math.round(((i+1)/names.length)*100);
                txt.innerText = `ì‘ì„± ì¤‘: ${names[i]} (${i+1}/${names.length})`;
                bar.style.width = per + "%";
                try { await api("generateDraft", { studentName: names[i], type: type, subject: sub }); cnt++; } catch(e){}
            }
            txt.innerText = "ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! (Drafts ì‹œíŠ¸ í™•ì¸)";
            showToast(`ì´ ${cnt}ëª…ì˜ ìƒê¸°ë¶€ ì´ˆì•ˆ ìƒì„± ì™„ë£Œ.`);
        }

        let rec = null;
        let isRecording = false;
        if (window.webkitSpeechRecognition) {
            rec = new webkitSpeechRecognition();
            rec.lang = 'ko-KR';
            rec.continuous = true;
            rec.interimResults = true;
            rec.onstart = () => { isRecording = true; document.getElementById('btn-mic').classList.add('mic-active'); document.getElementById('mic-status').style.display = 'flex'; };
            rec.onend = () => { isRecording = false; document.getElementById('btn-mic').classList.remove('mic-active'); document.getElementById('mic-status').style.display = 'none'; };
            rec.onresult = (e) => {
                const ta = document.getElementById('l-content');
                for (let i = e.resultIndex; i < e.results.length; ++i) if (e.results[i].isFinal) ta.value += (ta.value ? " " : "") + e.results[i][0].transcript;
                handleResize(ta);
            };
        }
        function toggleMic() { if (!rec) return alert("í¬ë¡¬ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”."); isRecording ? rec.stop() : rec.start(); }

    </script>
</body>
</html>
